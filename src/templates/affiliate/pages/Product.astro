---
import type { CollectionEntry } from "astro:content";
import { getLanguageFromId } from "@/i18n";
import { tt } from "../i18n";

interface Props {
  entry: CollectionEntry<"pages">;
}

const { entry } = Astro.props;
const language = getLanguageFromId(entry.id);
const tpl = tt(language);
const { title, description, link: directLink, rating } = entry.data;

const normalizeRatingKey = (value: string) =>
  value.trim().toLowerCase().replace(/\s+/g, " ");

const linkLabelKey = normalizeRatingKey(tpl.linkLabel);

const isLinkLabel = (label: string) => {
  const key = normalizeRatingKey(label);
  return key === "link" || key === linkLabelKey;
};

const isLinkValue = (value: string) => {
  const trimmed = value.trim();
  return trimmed.startsWith("http://") || trimmed.startsWith("https://");
};

const getRatingLink = (
  items?: Array<{ label: string; value: string | number }>
) => {
  if (!Array.isArray(items)) return undefined;
  for (const item of items) {
    if (!isLinkLabel(item.label)) continue;
    const value = String(item.value).trim();
    if (isLinkValue(value)) {
      return value;
    }
  }
  return undefined;
};

const link = directLink ?? getRatingLink(rating);
---

<section class="section">
  <h1>{title}</h1>
  {description && <p class="tpl-muted mb-4">{description}</p>}
  {link && (
    <a
      href={link}
      target="_blank"
      rel="noopener"
      class="tpl-button no-underline"
    >
      {tpl.visitLink} ->
    </a>
  )}
</section>

<slot />
