---
/**
 * Affiliate Site Layout
 * =====================
 * Minimal, clean layout for affiliate review sites.
 */

import { getRelativeLocaleUrl } from "astro:i18n";
import { t, toHreflang } from "@/i18n";
import {
  defaultLanguage,
  type LanguageCode,
  siteUrl,
  templateId,
  templateStyleId,
} from "@/config/site";
import SeoMeta from "@/components/global/head/SeoMeta.astro";
import SkipLink from "@/components/global/body/SkipLink.astro";
import { tt } from "./i18n";
import "#template-style";

interface Props {
  title: string;
  description?: string;
  language: LanguageCode;
  hreflangUrls?: Record<string, string>;
  switcherUrls?: Record<string, string>;
}

const {
  title,
  description,
  language,
  hreflangUrls = {},
  switcherUrls = {},
} = Astro.props;

const canonicalUrl = hreflangUrls[language] ?? `${siteUrl}${Astro.url.pathname}`;
const xDefaultUrl = hreflangUrls[defaultLanguage] ?? canonicalUrl;

// For switcher: combine relative URLs (internal) with absolute URLs (external)
const siteOrigin = siteUrl.replace(/\/$/, "");
const isExternalUrl = (url: string) => {
  if (!url.startsWith("http://") && !url.startsWith("https://")) return false;
  try {
    return new URL(url).origin !== siteOrigin;
  } catch {
    return false;
  }
};

const switcherLinks = Object.entries(hreflangUrls)
  .filter(([lang]) => {
    if (lang.includes("-")) {
      const baseLanguage = lang.split("-")[0];
      if (baseLanguage in hreflangUrls) return false;
    }
    return true;
  })
  .map(([lang, url]) => {
    if (!isExternalUrl(url) && lang in switcherUrls) {
      return [lang, switcherUrls[lang]] as [string, string];
    }
    return [lang, url] as [string, string];
  });

const ui = t(language);
const tpl = tt(language);
---

<!doctype html>
<html
  lang={toHreflang(language)}
  data-template={templateId}
  data-style={templateStyleId}
>
  <head>
    <SeoMeta
      title={title}
      description={description}
      canonicalUrl={canonicalUrl}
      hreflangUrls={hreflangUrls}
      xDefaultUrl={xDefaultUrl}
    />
  </head>

  <body class="tpl-page">
    <SkipLink targetId="main-content" />

    <header class="tpl-header">
      <div class="tpl-header-inner">
        <a href={getRelativeLocaleUrl(language, "")} class="tpl-brand">
          {ui.siteName}
        </a>

        <nav class="tpl-nav">
          <a href={getRelativeLocaleUrl(language, "")} class="tpl-nav-link">
            {tpl.home}
          </a>
          <a href={getRelativeLocaleUrl(language, "software/")} class="tpl-nav-link">
            {tpl.software}
          </a>
          <a href={getRelativeLocaleUrl(language, "websites/")} class="tpl-nav-link">
            {tpl.websites}
          </a>
        </nav>

        {switcherLinks.length > 1 && (
          <div class="tpl-switcher">
            {switcherLinks.map(([lang, url]) => (
              <a
                href={url}
                class:list={[
                  "tpl-switcher-link",
                  lang === language && "tpl-switcher-active",
                ]}
              >
                {lang.toUpperCase()}
              </a>
            ))}
          </div>
        )}
      </div>
    </header>

    <main id="main-content" class="tpl-main tpl-prose tpl-animate">
      <slot />
    </main>

    <footer class="tpl-footer">
      <div class="tpl-footer-inner">
        <div class="tpl-footer-grid">
          <div>
            <a
              href="https://affiliate.fm"
              target="_blank"
              rel="noopener"
              class="tpl-brand"
            >
              Affiliate.FM
            </a>
            <p class="tpl-footer-text" style="margin-top: 0.375rem;">
              Open-source tools for affiliate marketing
            </p>
          </div>
          <div class="tpl-footer-links">
            <a
              href="https://github.com/AffiliateFM"
              target="_blank"
              rel="noopener"
              class="tpl-footer-link"
            >
              GitHub
            </a>
            <a
              href="https://affiliate.fm"
              target="_blank"
              rel="noopener"
              class="tpl-footer-link"
            >
              Website
            </a>
          </div>
        </div>
        <p class="tpl-footer-text" style="margin-top: 1.5rem;">
          Built with
          <a
            href="https://github.com/affiliatefm/website-core-template"
            target="_blank"
            rel="noopener"
            class="tpl-link"
          >
            website-core-template
          </a>
        </p>
      </div>
    </footer>
  </body>
</html>
