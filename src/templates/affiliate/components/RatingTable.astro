---
/**
 * Rating Table
 * ============
 * Clean product comparison table.
 */

import { getCollection } from "astro:content";
import { defaultLanguage, type LanguageCode } from "@/config/site";
import { getIdPath, getLanguageFromId, getPageUrl } from "@/i18n";
import { getCollectionByName, getCollectionRouteInfo, type CollectionName } from "@/content-logic";
import { tt } from "../i18n";

interface Props {
  collection: CollectionName;
  limit?: number;
  offset?: number;
}

type RatingItem = {
  label: string;
  value: string | number;
};

type RatingColumn = {
  key: string;
  label: string;
};

const { collection, limit, offset } = Astro.props;
const collectionConfig = getCollectionByName(collection);

if (!collectionConfig) {
  throw new Error(`Unknown collection "${collection}". Check src/data/site.ts.`);
}

const currentLocale = (Astro.currentLocale as LanguageCode | undefined) ?? defaultLanguage;
const tpl = tt(currentLocale);

const entries = await getCollection("pages", ({ data, id }) =>
  !data.draft && getLanguageFromId(id) === currentLocale
);

const items = entries.filter((entry) => {
  const route = getCollectionRouteInfo(getIdPath(entry.id));
  return route && route.collection.collection === collectionConfig.collection;
});

const sorted = [...items].sort((a, b) =>
  a.data.title.localeCompare(b.data.title, currentLocale)
);
const start = Math.max(0, offset ?? 0);
const end = typeof limit === "number" ? start + limit : undefined;
const visible = sorted.slice(start, end);

const normalizeRatingKey = (value: string) =>
  value.trim().toLowerCase().replace(/\s+/g, " ");

const nameLabelKey = normalizeRatingKey(tpl.productLabel);
const linkLabelKey = normalizeRatingKey(tpl.linkLabel);
let nameColumnLabel = tpl.productLabel;

const isNameLabel = (label: string) => {
  const key = normalizeRatingKey(label);
  return key === "name" || key === "title" || key === "product" || key === nameLabelKey;
};

const isLinkLabel = (label: string) => {
  const key = normalizeRatingKey(label);
  return key === "link" || key === linkLabelKey;
};

const isLinkValue = (value: string) => {
  const trimmed = value.trim();
  return trimmed.startsWith("http://") || trimmed.startsWith("https://");
};

const getRatingItems = (entry: { data: { rating?: RatingItem[] } }) =>
  Array.isArray(entry.data.rating) ? entry.data.rating : [];

const splitRating = (entry: { data: { rating?: RatingItem[]; link?: string } }) => {
  const items = getRatingItems(entry);
  let link = entry.data.link?.trim();
  let name: string | undefined;
  let nameLabel: string | undefined;
  const fields: RatingItem[] = [];

  for (const item of items) {
    const value = String(item.value).trim();
    if (isNameLabel(item.label)) {
      if (value) name = value;
      if (!nameLabel) {
        const label = item.label.trim();
        if (label) nameLabel = label;
      }
      continue;
    }
    if (isLinkLabel(item.label)) {
      if (isLinkValue(value)) link = value;
      continue;
    }
    fields.push({ label: item.label, value });
  }

  if (link && !isLinkValue(link)) {
    link = undefined;
  }

  return { link, name, nameLabel, fields };
};

const ratingColumns: RatingColumn[] = [];
const ratingKeys = new Set<string>();

const ratingData = visible.map((entry) => {
  const { link, name, nameLabel, fields } = splitRating(entry);
  if (nameLabel && nameColumnLabel === tpl.productLabel) {
    nameColumnLabel = nameLabel;
  }
  const map = new Map<string, string>();
  for (const item of fields) {
    const key = normalizeRatingKey(item.label);
    if (!key) continue;
    if (!ratingKeys.has(key)) {
      ratingKeys.add(key);
      ratingColumns.push({ key, label: item.label });
    }
    map.set(key, String(item.value));
  }
  return { entry, link, name, values: map };
});
---

{ratingData.length > 0 && (
  <div class="tpl-scroll-x">
    <table class="tpl-table">
      <thead>
        <tr>
          <th style="min-width: 12rem;">{nameColumnLabel}</th>
          {ratingColumns.map((column) => (
            <th>{column.label}</th>
          ))}
          <th style="width: 7rem; text-align: right;">{tpl.linkLabel}</th>
        </tr>
      </thead>
      <tbody>
        {ratingData.map(({ entry, link, name, values }) => {
          const pageUrl = getPageUrl(entry);
          const { title } = entry.data;
          const displayTitle = name ?? title;
          return (
            <tr>
              <td>
                <a href={pageUrl} class="tpl-link" style="font-weight: 500;">
                  {displayTitle}
                </a>
              </td>
              {ratingColumns.map((column) => (
                <td class="tpl-text-muted">
                  {values.get(column.key) ?? "—"}
                </td>
              ))}
              <td style="text-align: right;">
                {link ? (
                  <a
                    href={link}
                    target="_blank"
                    rel="noopener"
                    class="tpl-button tpl-button-sm"
                  >
                    {tpl.visitLink}
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                      <path d="M7 17L17 7M17 7H7M17 7V17"/>
                    </svg>
                  </a>
                ) : (
                  <span class="tpl-text-tertiary">—</span>
                )}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>
)}
