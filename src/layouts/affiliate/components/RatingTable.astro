---
/**
 * Rating Table
 * ============
 * Product comparison table for a single collection.
 */

import { getCollection } from "astro:content";
import { defaultLanguage, type LanguageCode } from "@/config/site";
import { getIdPath, getLanguageFromId, getPageUrl } from "@/i18n";
import { getCollectionByName, getCollectionRouteInfo, type CollectionName } from "@/content-logic";
import { tt } from "../i18n";

interface Props {
  collection: CollectionName;
  limit?: number;
  offset?: number;
}

const { collection, limit, offset } = Astro.props;
const collectionConfig = getCollectionByName(collection);

if (!collectionConfig) {
  throw new Error(`Unknown collection "${collection}". Check src/data/site.ts.`);
}

const currentLocale = (Astro.currentLocale as LanguageCode | undefined) ?? defaultLanguage;
const tpl = tt(currentLocale);

const entries = await getCollection("pages", ({ data, id }) =>
  !data.draft && getLanguageFromId(id) === currentLocale
);

const items = entries.filter((entry) => {
  const route = getCollectionRouteInfo(getIdPath(entry.id));
  return route && route.collection.collection === collectionConfig.collection;
});

const sorted = [...items].sort((a, b) =>
  a.data.title.localeCompare(b.data.title, currentLocale)
);
const start = Math.max(0, offset ?? 0);
const end = typeof limit === "number" ? start + limit : undefined;
const visible = sorted.slice(start, end);
---

{visible.length > 0 && (
  <div class="overflow-x-auto -mx-5 px-5">
    <table class="w-full text-sm">
      <thead>
        <tr class="text-left text-xs font-medium text-gray-400 uppercase tracking-wide">
          <th class="w-12 pb-3">#</th>
          <th class="pb-3">Product</th>
          <th class="pb-3 w-36 text-right">{tpl.linkLabel}</th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-100">
        {visible.map((entry, index) => {
          const pageUrl = getPageUrl(entry);
          const { title, description, link } = entry.data;
          return (
            <tr
              class:list={[
                "group",
                index === 0 && "bg-emerald-50/50",
              ]}
            >
              <td class="py-4 pr-2">
                <span
                  class:list={[
                    "inline-flex items-center justify-center w-7 h-7 rounded-md text-sm font-medium",
                    index === 0 ? "bg-emerald-600 text-white" : "bg-gray-100 text-gray-600",
                  ]}
                >
                  {start + index + 1}
                </span>
              </td>
              <td class="py-4">
                <div class="min-w-0">
                  <div class="flex items-center gap-2">
                    <a href={pageUrl} class="font-medium text-gray-900 hover:text-blue-600">
                      {title}
                    </a>
                    {index === 0 && (
                      <span class="px-1.5 py-0.5 text-[10px] font-semibold uppercase bg-emerald-100 text-emerald-700 rounded">
                        Top
                      </span>
                    )}
                  </div>
                  {description && (
                    <p class="text-gray-500 text-xs mt-0.5 line-clamp-1">{description}</p>
                  )}
                </div>
              </td>
              <td class="py-4 text-right">
                {link ? (
                  <a
                    href={link}
                    target="_blank"
                    rel="noopener"
                    class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-white bg-gray-900 hover:bg-gray-800 rounded-md transition-colors"
                  >
                    {tpl.visitLink} →
                  </a>
                ) : (
                  <span class="text-xs text-gray-300">—</span>
                )}
              </td>
            </tr>
          );
        })}
      </tbody>
    </table>
  </div>
)
