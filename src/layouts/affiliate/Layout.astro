---
/**
 * Affiliate Site Layout
 * =====================
 * Modern, clean layout for affiliate marketing sites.
 * Part of the Affiliate.FM open-source ecosystem.
 */

import { getRelativeLocaleUrl } from "astro:i18n";
import { t, toHreflang } from "@/i18n";
import { defaultLanguage, languages, type LanguageCode, siteUrl } from "@/config/site";
import { tt } from "./i18n";

interface Props {
  title: string;
  description?: string;
  language: LanguageCode;
  hreflangUrls?: Record<string, string>;
  switcherUrls?: Record<string, string>;
}

const { title, description, language, hreflangUrls = {}, switcherUrls = {} } = Astro.props;

const canonicalUrl = hreflangUrls[language] ?? `${siteUrl}${Astro.url.pathname}`;
const xDefaultUrl = hreflangUrls[defaultLanguage] ?? canonicalUrl;
const hasMultipleLanguages = Object.keys(hreflangUrls).length > 1;

// For switcher: combine relative URLs (internal) with absolute URLs (external)
// Show all alternates except hreflang aliases (en-US when en exists)
const siteOrigin = siteUrl.replace(/\/$/, "");
const isExternalUrl = (url: string) => {
  if (!url.startsWith("http://") && !url.startsWith("https://")) return false;
  try {
    return new URL(url).origin !== siteOrigin;
  } catch {
    return false;
  }
};
const switcherLinks = Object.entries(hreflangUrls)
  .filter(([lang, url]) => {
    // Skip hreflang aliases (en-US) if base language (en) exists
    if (lang.includes("-")) {
      const baseLanguage = lang.split("-")[0];
      if (baseLanguage in hreflangUrls) return false;
    }
    return true;
  })
  .map(([lang, url]) => {
    // For internal URLs, prefer relative version from switcherUrls
    if (!isExternalUrl(url) && lang in switcherUrls) {
      return [lang, switcherUrls[lang]] as [string, string];
    }
    return [lang, url] as [string, string];
  });

// Two translation layers:
// - ui: user data (siteName, custom strings) from src/data/ui.ts
// - tpl: template strings (nav, buttons) from ./i18n.ts
const ui = t(language);
const tpl = tt(language);
---

<!doctype html>
<html lang={toHreflang(language)} class="antialiased">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{title}</title>
    {description && <meta name="description" content={description} />}
    <link rel="canonical" href={canonicalUrl} />
    {hasMultipleLanguages && Object.entries(hreflangUrls).map(([lang, url]) => (
      <link rel="alternate" hreflang={toHreflang(lang)} href={url} />
    ))}
    {hasMultipleLanguages && <link rel="alternate" hreflang="x-default" href={xDefaultUrl} />}
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  </head>

  <body class="min-h-screen bg-white text-gray-900">
    <div class="flex flex-col min-h-screen">
      <!-- Header -->
      <header class="sticky top-0 z-50 bg-white/95 backdrop-blur border-b border-gray-100">
        <div class="max-w-3xl mx-auto px-5 h-14 flex items-center justify-between">
          <a href={getRelativeLocaleUrl(language, "")} class="font-semibold text-gray-900 hover:text-blue-600 transition-colors">
            {ui.siteName}
          </a>
          
          <nav class="flex items-center gap-1">
            <a href={getRelativeLocaleUrl(language, "")} class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 rounded-md hover:bg-gray-50 transition-colors">
              {tpl.home}
            </a>
            <a href={getRelativeLocaleUrl(language, "docs/")} class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 rounded-md hover:bg-gray-50 transition-colors">
              {tpl.docs}
            </a>
            <a href="https://github.com/AffiliateFM" target="_blank" rel="noopener" class="px-3 py-1.5 text-sm text-gray-600 hover:text-gray-900 rounded-md hover:bg-gray-50 transition-colors">
              GitHub
            </a>
          </nav>

          {switcherLinks.length > 1 && (
            <div class="flex gap-0.5">
              {switcherLinks.map(([lang, url]) => (
                <a
                  href={url}
                  class:list={[
                    "px-2 py-1 text-xs font-medium rounded transition-colors",
                    lang === language ? "bg-gray-900 text-white" : "text-gray-400 hover:text-gray-600"
                  ]}
                >
                  {lang.toUpperCase()}
                </a>
              ))}
            </div>
          )}
        </div>
      </header>

      <!-- Main -->
      <main class="flex-1 max-w-3xl mx-auto w-full px-5 py-10">
        <slot />
      </main>

      <!-- Footer -->
      <footer class="border-t border-gray-100 bg-gray-50">
        <div class="max-w-3xl mx-auto px-5 py-8">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div>
              <a href="https://affiliate.fm" target="_blank" rel="noopener" class="font-semibold text-gray-900 hover:text-blue-600 transition-colors">
                Affiliate.FM
              </a>
              <p class="text-xs text-gray-500 mt-1">
                Independent media & open-source tools for affiliate marketing
              </p>
            </div>
            <div class="flex gap-4 text-sm">
              <a href="https://github.com/AffiliateFM" target="_blank" rel="noopener" class="text-gray-500 hover:text-gray-900 transition-colors">
                GitHub
              </a>
              <a href="https://affiliate.fm" target="_blank" rel="noopener" class="text-gray-500 hover:text-gray-900 transition-colors">
                Website
              </a>
            </div>
          </div>
          <p class="text-xs text-gray-400 mt-6">
            Built with <a href="https://github.com/affiliatefm/website-core-template" target="_blank" rel="noopener" class="text-gray-500 hover:text-gray-700">website-core-template</a> â€” reusable static site generator by Affiliate.FM
          </p>
        </div>
      </footer>
    </div>
  </body>
</html>

<style is:global>
  /* Base prose styles for MDX content */
  h1 { @apply text-2xl font-semibold text-gray-900 mb-4 tracking-tight; }
  h2 { @apply text-lg font-semibold text-gray-900 mt-10 mb-3; }
  h3 { @apply text-base font-semibold text-gray-900 mt-6 mb-2; }
  p { @apply text-gray-600 mb-4 leading-relaxed; }
  a { @apply text-blue-600 hover:text-blue-700; }
  ul, ol { @apply mb-4 pl-5 text-gray-600; }
  li { @apply mb-1; }
  strong { @apply font-semibold text-gray-900; }
  hr { @apply my-8 border-gray-200; }
  
  table { @apply w-full text-sm mb-6; }
  th { @apply text-left text-xs font-medium text-gray-500 uppercase tracking-wide pb-3 border-b border-gray-200; }
  td { @apply py-3 border-b border-gray-100 text-gray-600; }

  code { @apply text-sm bg-gray-100 px-1.5 py-0.5 rounded; }
  pre { @apply bg-gray-900 text-gray-100 p-4 rounded-lg text-sm overflow-x-auto mb-6; }
  pre code { @apply bg-transparent p-0; }

  blockquote { @apply border-l-2 border-blue-500 pl-4 my-6 text-gray-600 italic; }

  .section { @apply mb-12; }
  
  .badge { @apply inline-flex items-center px-2 py-0.5 text-xs font-medium rounded; }
  .badge-blue { @apply bg-blue-100 text-blue-700; }
  .badge-green { @apply bg-emerald-100 text-emerald-700; }
</style>
