---
/**
 * Default locale pages (no prefix)
 * Handles: /, /about, /contact, /docs/getting-started
 */

import { getCollection, render } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { defaultLocale, locales, getUrlSlug, getAlternateUrls } from "@/i18n";

export async function getStaticPaths() {
  const allPages = await getCollection("pages", ({ data }) => !data.draft);
  const otherLocales = locales.filter((l) => l !== defaultLocale);

  // Guard against default-locale slugs that collide with locale prefixes (e.g., ru.mdx)
  const reservedSlugConflicts = allPages.filter((page) => {
    const firstSegment = page.id.split("/")[0];
    return !page.id.includes("/") && otherLocales.includes(firstSegment as any);
  });

  if (reservedSlugConflicts.length > 0) {
    const list = reservedSlugConflicts.map((p) => `"${p.id}"`).join(", ");
    throw new Error(
      `Default-locale pages cannot use slugs reserved for locale prefixes (${list}).`
    );
  }
  
  const defaultLocalePages = allPages.filter((page) => {
    const firstSegment = page.id.split("/")[0];
    return !otherLocales.includes(firstSegment as any);
  });

  return defaultLocalePages.map((entry) => ({
    params: { path: getUrlSlug(entry) || undefined },
    props: { entry, allPages },
  }));
}

const { entry, allPages } = Astro.props;
const { Content } = await render(entry);
const alternates = getAlternateUrls(entry, allPages, { site: Astro.site, absolute: true });
---

<BaseLayout
  title={entry.data.title}
  description={entry.data.description}
  locale={defaultLocale}
  alternates={alternates}
>
  <Content />
</BaseLayout>
