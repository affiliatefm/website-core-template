---
/**
 * Universal Page Router
 * =====================
 * Single route handler for all pages (all locales).
 *
 * Handles:
 * - /                        → default locale index
 * - /about                   → default locale page
 * - /docs/getting-started    → default locale nested page
 * - /ru                      → non-default locale index
 * - /ru/about                → non-default locale page
 * - /ru/docs/getting-started → non-default locale nested page
 */

import { getCollection, render } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import {
  locales,
  defaultLocale,
  type Locale,
  getLocaleFromId,
  getUrlSlug,
  getAlternateUrls,
} from "@/i18n";

export async function getStaticPaths() {
  const allPages = await getCollection("pages", ({ data }) => !data.draft);
  const nonDefaultLocales = locales.filter((l) => l !== defaultLocale);

  const paths = [];

  // Track slugs per locale to detect duplicates
  const slugsByLocale = new Map<string, Map<string, string>>();
  for (const loc of locales) {
    slugsByLocale.set(loc, new Map());
  }

  for (const entry of allPages) {
    const locale = getLocaleFromId(entry.id);
    const slug = getUrlSlug(entry);

    // Check for duplicate permalinks within the same locale
    const localeSlugMap = slugsByLocale.get(locale)!;
    if (localeSlugMap.has(slug)) {
      const existingId = localeSlugMap.get(slug);
      throw new Error(
        `Duplicate permalink "${slug || "/"}" for locale "${locale}": ` +
          `found in both "${existingId}" and "${entry.id}". ` +
          `Use unique permalinks or rename files.`
      );
    }
    localeSlugMap.set(slug, entry.id);

    if (locale === defaultLocale) {
      // Default locale: no prefix
      // /about, /docs/getting-started, / (empty slug)
      paths.push({
        params: { slug: slug || undefined },
        props: { entry, locale, allPages },
      });
    } else {
      // Non-default locale: with prefix
      // /ru, /ru/about, /ru/docs/getting-started
      const fullSlug = slug ? `${locale}/${slug}` : locale;
      paths.push({
        params: { slug: fullSlug },
        props: { entry, locale, allPages },
      });
    }
  }

  // Validate: no default locale page should conflict with locale prefixes
  const defaultLocalePages = allPages.filter(
    (p) => getLocaleFromId(p.id) === defaultLocale
  );
  const conflicts = defaultLocalePages.filter((p) => {
    const slug = getUrlSlug(p);
    return nonDefaultLocales.includes(slug as Locale);
  });

  if (conflicts.length > 0) {
    const list = conflicts.map((p) => `"${p.id}"`).join(", ");
    throw new Error(
      `Default locale pages cannot use slugs reserved for locale prefixes: ${list}`
    );
  }

  return paths;
}

const { entry, locale, allPages } = Astro.props;
const alternates = getAlternateUrls(entry, allPages, { absolute: true });
const { Content } = await render(entry);
---

<BaseLayout
  title={entry.data.title}
  description={entry.data.description}
  locale={locale}
  alternates={alternates}
>
  <Content />
</BaseLayout>
